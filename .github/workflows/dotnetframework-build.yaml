name: Build API Network (Reusable)

on:
  workflow_call:
    inputs:
      runner:
        required: false
        type: string
        default: windows-latest

      vs-version:
        required: true
        type: string

      msbuild-solution:
        required: true
        type: string

      run-sonar:
        required: false
        type: boolean
        default: false

      sonar-project-key:
        required: false
        type: string

      sonar-exclude:
        required: false
        type: string

      vsonar-vstest-report:
        required: false
        type: string

      vsonar-opencover-report:
        required: false
        type: string

      run-tests:
        required: false
        type: boolean
        default: false

      test-project-path:
        required: false
        type: string

      test-dll-path:
        required: false
        type: string

      run-whitelist:
        required: false
        type: boolean
        default: false

      ssh-port:
        required: false
        type: string
        default: "22"

    secrets:
      SONAR_HOST_URL:
        required: false
      SONAR_TOKEN:
        required: false
      AWS_REGION:
        required: true
      SG_ID:
        required: true
      AWS_OIDC_ROLE:
        required: true

permissions:
  id-token: write
  contents: read

jobs:

# =========================================================
# 1️⃣ SONAR JOB (OPTIONAL)
# =========================================================
  sonar:
    if: ${{ inputs.run-sonar == true }}
    runs-on: ${{ inputs.runner }}

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: microsoft/setup-msbuild@v2
        with:
          vs-version: ${{ inputs.vs-version }}

      - name: Install Sonar Scanner
        shell: pwsh
        run: |
          dotnet tool install --global dotnet-sonarscanner
          $env:PATH += ";$env:USERPROFILE\.dotnet\tools"

      - name: Sonar Begin
        shell: pwsh
        run: |
          dotnet sonarscanner begin `
            /k:"${{ inputs.sonar-project-key }}" `
            /d:sonar.host.url="${{ secrets.SONAR_HOST_URL }}" `
            /d:sonar.token="${{ secrets.SONAR_TOKEN }}" `
            /d:sonar.exclusions="${{ inputs.sonar-exclude }}"

      - name: Build
        shell: pwsh
        run: |
          msbuild "${{ inputs.msbuild-solution }}" `
            /t:Rebuild `
            /p:Configuration=Release

      - name: Run Tests
        if: ${{ inputs.run-tests == true }}
        shell: pwsh
        run: |
          vstest.console.exe "${{ inputs.test-dll-path }}"

      - name: Sonar End
        shell: pwsh
        run: |
          dotnet sonarscanner end `
            /d:sonar.token="${{ secrets.SONAR_TOKEN }}"

# =========================================================
# 2️⃣ WHITELIST JOB (OPTIONAL)
# =========================================================
  whitelist:
    if: ${{ inputs.run-whitelist == true }}
    runs-on: ubuntu-latest

    outputs:
      ip: ${{ steps.ip.outputs.ip }}

    steps:
      - name: Configure AWS OIDC
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_OIDC_ROLE }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Get Public IP
        id: ip
        run: |
          IP=$(curl -s https://checkip.amazonaws.com | xargs)
          echo "ip=$IP" >> $GITHUB_OUTPUT

      - name: Authorize Security Group
        run: |
          aws ec2 authorize-security-group-ingress \
            --group-id "${{ secrets.SG_ID }}" \
            --protocol tcp \
            --port ${{ inputs.ssh-port }} \
            --cidr "${{ steps.ip.outputs.ip }}/32" \
            --region "${{ secrets.AWS_REGION }}" \
            --no-cli-pager || echo "Rule may already exist"

# =========================================================
# 3️⃣ BUILD + DEPLOY JOB
# =========================================================
  build-and-deploy:
    needs: [sonar, whitelist]
    if: ${{ always() && (inputs.run-sonar == false || needs.sonar.result == 'success') }}
    runs-on: ${{ inputs.runner }}

    steps:
      - uses: actions/checkout@v4

      - uses: microsoft/setup-msbuild@v2
        with:
          vs-version: ${{ inputs.vs-version }}

      - name: Build Project
        shell: pwsh
        run: |
          msbuild "${{ inputs.msbuild-solution }}" `
            /t:Rebuild `
            /p:Configuration=Release `
            /p:DeployOnBuild=true

      - name: Configure AWS OIDC
        uses: aws-actions/configure-aws-credentials@v4
        if: ${{ inputs.run-whitelist == true }}
        with:
          role-to-assume: ${{ secrets.AWS_OIDC_ROLE }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Remove Temporary Rule
        if: ${{ inputs.run-whitelist == true }}
        shell: pwsh
        run: |
          aws ec2 revoke-security-group-ingress `
            --group-id "${{ secrets.SG_ID }}" `
            --protocol tcp `
            --port ${{ inputs.ssh-port }} `
            --cidr "${{ needs.whitelist.outputs.ip }}/32" `
            --region "${{ secrets.AWS_REGION }}" `
            --no-cli-pager || echo "Rule already removed"
