name: Build API Network (Reusable)

on:
  workflow_call:
    inputs:
      runner:
        description: 'Runner to use for Windows jobs (default: windows-latest)'
        required: false
        type: string
        default: windows-latest

      vs-version:
        description: 'dotnet framework version'
        required: true
        type: string
      
      msbuild-solution:
        description: 'Path to the .sln or .csproj file (relative to repo root)'
        required: true
        type: string
      
      sonar-project-key:
        description: 'SonarQube project key'
        required: true
        type: string

      sonar-exclude:
        description: 'SonarQube exclude'
        required: false
        type: string

      vsonar-vstest-report:
        required: false
        type: string

      vsonar-opencover-report:
        required: false
        type: string
      
      ssh-port:
        description: 'SSH port to temporarily allow (usually 22)'
        required: false
        type: string
        default: '22'

      run-tests:
        required: false
        type: boolean
        default: false
      test-project-path:
        required: false
        type: string
      test-dll-path:
        required: false
        type: string

    secrets:
      SONAR_HOST_URL:
        required: true
      SONAR_TOKEN:
        required: true
      AWS_REGION:
        required: true
      SG_ID:
        required: true
      AWS_OIDC_ROLE:
        required: true

permissions:
  id-token: write
  contents: read

jobs:
  # =========================================================
  # JOB 1 â€“ SONAR SCANNING
  # =========================================================
  sonar:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Required for accurate Sonar analysis

      - name: Install Sonar Scanner (MSBuild)
        shell: pwsh
        run: |
          $url = "https://github.com/SonarSource/sonar-scanner-msbuild/releases/download/11.0.0.126294/sonar-scanner-11.0.0.126294-net-framework.zip"
          Invoke-WebRequest -Uri $url -OutFile "sonar.zip"
          Expand-Archive sonar.zip -DestinationPath "C:\sonar"
          echo "SONAR_SCANNER_HOME=C:\sonar" >> $env:GITHUB_ENV

      - uses: microsoft/setup-msbuild@v2

      # - name: Sonar Begin
      #   shell: pwsh
      #   run: |
      #     & "C:\sonar\SonarScanner.MSBuild.exe" begin `
      #       /k:"${{ inputs.sonar-project-key }}" `
      #       /d:sonar.host.url="${{ secrets.SONAR_HOST_URL }}" `
      #       /d:sonar.token="${{ secrets.SONAR_TOKEN }}" `
      #       /d:sonar.verbose=true `
      #       /d:sonar.exclusions="${{ inputs.sonar-exclude }}" `
      #       /d:sonar.cs.vstest.reportsPaths=${{ inputs.sonar-exclude }}" 
      #       /d:sonar.cs.opencover.reportsPaths=${{ inputs.sonar-exclude }}"

      - name: Sonar Begin
        shell: pwsh
        run: |
          $args = @(
            'begin'
            "/k:${{ inputs.sonar-project-key }}"
            "/d:sonar.host.url=${{ secrets.SONAR_HOST_URL }}"
            "/d:sonar.token=${{ secrets.SONAR_TOKEN }}"
            "/d:sonar.verbose=true"
          )

          # Optional: sonar.exclusions
          if ("${{ inputs.sonar-exclude }}" -ne "") {
            $args += "/d:sonar.exclusions=${{ inputs.sonar-exclude }}"
          }

          # Optional: VsTest report paths
          if ("${{ inputs.vsonar-vstest-report }}" -ne "") {
            $args += "/d:sonar.cs.vstest.reportsPaths=${{ inputs.vsonar-vstest-report }}"
          }

          # Optional: OpenCover report paths
          if ("${{ inputs.vsonar-opencover-report }}" -ne "") {
            $args += "/d:sonar.cs.opencover.reportsPaths=${{ inputs.vsonar-opencover-report }}"
          }

          # Execute scanner
          & "C:\sonar\SonarScanner.MSBuild.exe" @args
      
      - name: Build for Sonar
        shell: pwsh
        run: |
                msbuild "${{ inputs.msbuild-solution }}" `
                  /t:Rebuild `
                  /p:Configuration=Release

      # - name: Sonar End
      #   shell: pwsh
      #   run: |
      #     & "C:\sonar\SonarScanner.MSBuild.exe" end `
      #     /d:sonar.token="${{ secrets.SONAR_TOKEN }}"

      # ============================================================
      # ðŸŸ¨ TEST + COVERAGE (OPTIONAL)
      # ============================================================
      - name: Run Tests With Coverage
        if: ${{ inputs.run-tests == true }}
        shell: pwsh
        run: |
          dotnet tool install --global coverlet.console --version 6.0.2
          $env:PATH += ";$env:USERPROFILE\.dotnet\tools"

          if ("${{ inputs.test-project-path }}" -eq "" -or "${{ inputs.test-dll-path }}" -eq "") {
            Write-Host "Test paths not provided â€” skipping test execution."
            exit 0
          }

          New-Item -ItemType Directory -Force -Path "${{ inputs.test-project-path }}\TestResults" | Out-Null

          coverlet `
            "${{ inputs.test-dll-path }}" `
            --target "C:\Program Files\Microsoft Visual Studio\2022\Enterprise\Common7\IDE\Extensions\TestPlatform\vstest.console.exe" `
            --targetargs "`"${{ inputs.test-dll-path }}`" /Logger:trx /ResultsDirectory:`"${{ inputs.test-project-path }}\TestResults`"" `
            --format opencover `
            --output "${{ inputs.test-project-path }}\coverage.opencover.xml"

          if (!(Test-Path "${{ inputs.test-project-path }}\coverage.opencover.xml")) {
            Write-Error "OpenCover file was not generated! Tests may have failed."
            exit 1
          }

      # ============================================================
      # ðŸŸ¥ SONAR END (FAILS JOB IF QUALITY GATE FAILS)
      # ============================================================
      - name: SonarScanner End
        shell: pwsh
        run: |
          & "C:\sonar\SonarScanner.MSBuild.exe" end `
            /d:sonar.token="${{ secrets.SONAR_TOKEN }}"

  # =========================================================
  # JOB 2 â€“ TEMPORARY AWS SECURITY GROUP WHITELIST
  # =========================================================
  whitelist:
    runs-on: ubuntu-latest
    outputs:
      ip: ${{ steps.ip.outputs.ip }}
    steps:
      - name: Configure AWS OIDC
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_OIDC_ROLE }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Get Runner Public IP
        id: ip
        run: |
          IP=$(curl -s https://checkip.amazonaws.com | xargs)
          echo "ip=$IP" >> $GITHUB_OUTPUT

      - name: Add Temporary SSH Ingress Rule
        run: |
          CIDR="${{ steps.ip.outputs.ip }}/32"
          aws ec2 authorize-security-group-ingress \
            --region "${{ secrets.AWS_REGION }}" \
            --group-id "${{ secrets.SG_ID }}" \
            --protocol tcp \
            --port ${{ inputs.ssh-port }} \
            --cidr "$CIDR" \
            --no-cli-pager || echo "Rule may already exist"

  # =========================================================
  # JOB 3 â€“ BUILD + PACKAGE + DEPLOY
  # =========================================================
  build-and-deploy:
    runs-on: ${{ inputs.runner }}
    needs: [sonar, whitelist]
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 1
          ref: ${{ github.sha }}

      - uses: microsoft/setup-msbuild@v2
        with:
          vs-version: ${{ inputs.vs-version }}

      - name: Build and Package API Project
        shell: pwsh
        run: |
          msbuild "${{ inputs.msbuild-solution }}" `
            /t:Rebuild `
            /p:Configuration=Release `
            /p:DeployOnBuild=true `
            /p:PackageTempRootDir="obj\Release\Package\"

      - name: Cleanup Temporary Package Files (Optional)
        if: always()
        shell: pwsh
        run: |
          Remove-Item "obj\Release\Package\" -Recurse -Force -ErrorAction SilentlyContinue
      
      - name: Configure AWS OIDC
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_OIDC_ROLE }}
          aws-region: ${{ secrets.AWS_REGION }}
          
      - name: Remove Temporary SSH Ingress Rule
        if: always()
        shell: pwsh
        run: |
          $CIDR = "${{ needs.whitelist.outputs.ip }}/32"
          aws ec2 revoke-security-group-ingress `
            --region "${{ secrets.AWS_REGION }}" `
            --group-id "${{ secrets.SG_ID }}" `
            --protocol tcp `
            --port ${{ inputs.ssh-port }} `
            --cidr "$CIDR" `
            --no-cli-pager || echo "Rule already removed or never existed"