name: Build API Network (Reusable)

on:
  workflow_call:
    inputs:
      runner:
        description: 'Runner to use for Windows jobs (default: windows-latest)'
        required: false
        type: string
        default: windows-latest
      
      msbuild-solution:
        description: 'Path to the .sln or .csproj file (relative to repo root)'
        required: true
        type: string
      
      sonar-project-key:
        description: 'SonarQube project key'
        required: true
        type: string
      
      ssh-port:
        description: 'SSH port to temporarily allow (usually 22)'
        required: false
        type: string
        default: '22'

    secrets:
      SONAR_HOST_URL:
        required: true
      SONAR_TOKEN:
        required: true
      AWS_REGION:
        required: true
      SG_ID:
        required: true
      AWS_OIDC_ROLE:
        required: true

permissions:
  id-token: write
  contents: read

jobs:
  # =========================================================
  # JOB 1 – SONAR SCANNING
  # =========================================================
  sonar:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Required for accurate Sonar analysis

      - name: Install Sonar Scanner (MSBuild)
        shell: pwsh
        run: |
          $url = "https://github.com/SonarSource/sonar-scanner-msbuild/releases/download/11.0.0.126294/sonar-scanner-11.0.0.126294-net-framework.zip"
          Invoke-WebRequest -Uri $url -OutFile "sonar.zip"
          Expand-Archive sonar.zip -DestinationPath "C:\sonar"
          echo "SONAR_SCANNER_HOME=C:\sonar" >> $env:GITHUB_ENV

      - uses: microsoft/setup-msbuild@v2

      - name: Sonar Begin
        shell: pwsh
        run: |
          & "C:\sonar\SonarScanner.MSBuild.exe" begin `
            /k:"${{ inputs.sonar-project-key }}" `
            /d:sonar.host.url="${{ secrets.SONAR_HOST_URL }}" `
            /d:sonar.token="${{ secrets.SONAR_TOKEN }}" `
            /d:sonar.verbose=true

      - name: Build for Sonar
        shell: pwsh
        run: |
          msbuild "${{ inputs.msbuild-solution }}" `
            /t:Rebuild `
            /p:Configuration=Release

      - name: Sonar End
        shell: pwsh
        run: |
          & "C:\sonar\SonarScanner.MSBuild.exe" end `
            /d:sonar.token="${{ secrets.SONAR_TOKEN }}"

  # =========================================================
  # JOB 2 – TEMPORARY AWS SECURITY GROUP WHITELIST
  # =========================================================
  whitelist:
    runs-on: ubuntu-latest
    outputs:
      ip: ${{ steps.ip.outputs.ip }}
    steps:
      - name: Configure AWS OIDC
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_OIDC_ROLE }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Get Runner Public IP
        id: ip
        run: |
          IP=$(curl -s https://checkip.amazonaws.com | xargs)
          echo "ip=$IP" >> $GITHUB_OUTPUT

      - name: Add Temporary SSH Ingress Rule
        run: |
          CIDR="${{ steps.ip.outputs.ip }}/32"
          aws ec2 authorize-security-group-ingress \
            --region "${{ secrets.AWS_REGION }}" \
            --group-id "${{ secrets.SG_ID }}" \
            --protocol tcp \
            --port ${{ inputs.ssh-port }} \
            --cidr "$CIDR" \
            --no-cli-pager || echo "Rule may already exist"

  # =========================================================
  # JOB 3 – BUILD + PACKAGE + DEPLOY
  # =========================================================
  build-and-deploy:
    runs-on: ${{ inputs.runner }}
    needs: [sonar, whitelist]
    steps:
      - uses: actions/checkout@v4

      - uses: microsoft/setup-msbuild@v2

      - name: Build and Package API Project
        shell: pwsh
        run: |
          msbuild "${{ inputs.msbuild-solution }}" `
            /t:Rebuild `
            /p:Configuration=Release `
            /p:DeployOnBuild=true `
            /p:PackageTempRootDir="obj\Release\Package\"

      - name: Cleanup Temporary Package Files (Optional)
        if: always()
        shell: pwsh
        run: |
          Remove-Item "obj\Release\Package\" -Recurse -Force -ErrorAction SilentlyContinue

      - name: Remove Temporary SSH Ingress Rule
        if: always()
        run: |
          CIDR="${{ needs.whitelist.outputs.ip }}/32"
          aws ec2 revoke-security-group-ingress `
            --region "${{ secrets.AWS_REGION }}" `
            --group-id "${{ secrets.SG_ID }}" `
            --protocol tcp `
            --port ${{ inputs.ssh-port }} `
            --cidr "$CIDR" `
            --no-cli-pager || echo "Rule already removed or never existed"