name: Build Python App (Reusable)

on:
  workflow_call:
    inputs:
      create-dotenv:
        description: 'Whether to create .env file from secrets'
        required: false
        type: boolean
        default: false

      enable-aws-sg-whitelist:
        description: 'Temporarily whitelist runner IP in AWS Security Group'
        required: false
        type: boolean
        default: false

      aws-role-arn:
        description: 'ARN of IAM role to assume for SG modification'
        required: false
        type: string

      aws-region:
        description: 'AWS region for Security Group'
        required: false
        type: string
        default: us-east-1

      aws-security-group-id:
        description: 'Security Group ID to modify'
        required: false
        type: string

      # Existing inputs
      runner-build:
        description: 'Runner for Python jobs'
        required: false
        type: string
        default: ubuntu-latest

      run-gitleaks:
        description: 'Run Gitleaks secret scanning'
        required: false
        type: boolean
        default: false

      python-version:
        description: 'Python version to use'
        required: true
        type: string

      sonar-project-key:
        description: 'SonarQube project key'
        required: true
        type: string

      sonar-exclude:
        description: 'SonarQube exclude patterns'
        required: false
        type: string
        default: '**/venv/**,**/.venv/**,**/dist/**,**/build/**,**/*.pyc,**/__pycache__/**'

      run-tests:
        description: 'Run pytest with coverage'
        required: false
        type: boolean
        default: true

      coverage-xml-path:
        description: 'Path to coverage XML report'
        required: false
        type: string
        default: coverage.xml

      working-directory:
        description: 'Directory where the Python app lives'
        required: false
        type: string
        default: '.'

      # .env inputs (if create-dotenv is true)
      DBNAME:
        required: false
        type: string
      DBUSERNAME:
        required: false
        type: string
      DBHOST:
        required: false
        type: string
      TENANTID:
        required: false
        type: string
      CLIENTID:
        required: false
        type: string

    secrets:
      SONAR_HOST_URL:
        required: true
      SONAR_TOKEN:
        required: true
      DBPASSWORD:
        required: false
      CLIENTSECRET:
        required: false
      OTHER_SECRET:
        required: false

permissions:
  contents: read
  id-token: write  # Required for OIDC AWS assume role
  pull-requests: read

jobs:
  gitleaks:
    runs-on: ${{ inputs.runner-build }}
    if: ${{ inputs.run-gitleaks == true }}
    defaults:
      run:
        working-directory: ${{ inputs.working-directory }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install Gitleaks
        run: |
          curl -sSL https://github.com/gitleaks/gitleaks/releases/download/v8.18.4/gitleaks_8.18.4_linux_x64.tar.gz | tar xz
          sudo mv gitleaks /usr/local/bin/

      - name: Run Gitleaks (non-blocking)
        run: |
          set +e
          gitleaks detect --source . -v --redact
          echo "Gitleaks finished; leaks (if any) do not fail the build."
          set -e
          
  setup-sg-whitelist:
    runs-on: ${{ inputs.runner-build }}
    if: ${{ inputs.enable-aws-sg-whitelist == true }}
  
    outputs:
      runner-ip: ${{ steps.ip.outputs.ip4 }}
  
    steps:
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ inputs.aws-role-arn }}
          aws-region: ${{ inputs.aws-region }}
  
      - name: Get Runner Public IP
        id: ip
        uses: haythem/public-ip@v1.3
  
      - name: Add Runner IP to Security Group
        shell: bash
        run: |
          set -e
      
          IP="${{ steps.ip.outputs.ipv4 }}/32"
          echo "Whitelisting IP: $IP"
      
          aws ec2 authorize-security-group-ingress \
            --region ${{ inputs.aws-region }} \
            --group-id ${{ inputs.aws-security-group-id }} \
            --protocol tcp \
            --port 22 \
            --cidr "$IP" \
          || echo "Rule already exists for port 22"
      
          aws ec2 authorize-security-group-ingress \
            --region ${{ inputs.aws-region }} \
            --group-id ${{ inputs.aws-security-group-id }} \
            --protocol tcp \
            --port 3306 \
            --cidr "$IP" \
          || echo "Rule already exists for port 3306"



  # ============================
  # Job 3 - Tests + Sonar
  # ============================
  # sonar:
  #   runs-on: ${{ inputs.runner-build }}
  #   needs: [gitleaks, setup-sg-whitelist]
  #   if: ${{ always() && (needs.gitleaks.result == 'success' || needs.gitleaks.result == 'skipped') }}
  #   defaults:
  #     run:
  #       working-directory: ${{ inputs.working-directory }}

  #   steps:
  #     - uses: actions/checkout@v4
  #       with:
  #         fetch-depth: 0

      - name: Inject config and create .env (Jenkins configFileProvider equivalent)
        if: ${{ inputs.create-dotenv == true }}
        run: |
          cat <<EOF > .env
          DBNAME=${{ inputs.DBNAME }}
          DBUSERNAME=${{ inputs.DBUSERNAME }}
          DBPASSWORD=${{ secrets.DBPASSWORD }}
          DBHOST=${{ inputs.DBHOST }}
          TENANTID=${{ inputs.TENANTID }}
          CLIENTID=${{ inputs.CLIENTID }}
          CLIENTSECRET=${{ secrets.CLIENTSECRET }}
          EOF

      - name: Test MySQL connection (more verbose)
        if: ${{ inputs.create-dotenv == true }}
        run: |
          source .env
          
          echo "Trying to connect to:"
          echo "  Host: $DBHOST"
          echo "  User: $DBUSERNAME"
          echo "  DB:   $DBNAME"
          echo "  Runner public IP should be whitelisted: $(curl -s ifconfig.me)"
          
          # Quick connectivity check (no auth needed)
          nc -zv -w 8 "$DBHOST" 3306 && echo "Port 3306 reachable ✓" || echo "Port 3306 NOT reachable ✗"
          
          # Real connection attempt
          MYSQL_PWD="$DBPASSWORD" \
          mysql --host="$DBHOST" \
                --user="$DBUSERNAME" \
                --port=3306 \
                --connect-timeout=12 \
                -e "SELECT VERSION() AS version, DATABASE() AS current_db;" \
                "$DBNAME" 2>&1 || {
            echo "!!! Connection failed - see above for details !!!"
            exit 1
          }


          
      # - name: Set up Python
      #   uses: actions/setup-python@v5
      #   with:
      #     python-version: ${{ inputs.python-version }}

      # - name: Install dependencies
      #   run: |
      #     pip install python-dotenv mysql-connector-python

      # - name: Debug – Test DB connection
      #   if: ${{ inputs.create-dotenv == true }}
      #   run: |
      #     python - <<'EOF'
      #     import os, sys
      #     from dotenv import load_dotenv
      #     import mysql.connector
      
      #     load_dotenv(dotenv_path=".env")
      
      #     try:
      #         conn = mysql.connector.connect(
      #             host=os.getenv("DBHOST"),
      #             user=os.getenv("DBUSERNAME"),
      #             password=os.getenv("DBPASSWORD"),
      #             database=os.getenv("DBNAME"),
      #             connection_timeout=5
      #         )
      #         print("✅ Database connection successful")
      #         conn.close()
      #     except Exception as e:
      #         print("❌ Database connection failed")
      #         print(e)
      #         sys.exit(1)
      #     EOF


      - name: Create Virtual Environment
        run: |
          python -m venv venv
          source venv/bin/activate
          which python

      - name: Install Packages
        run: |
          source venv/bin/activate
          pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest coverage

      - name: Run Tests & Coverage
        run: |
          source venv/bin/activate
          coverage run -m pytest
          coverage xml
          
      - name: SonarQube Scan
        uses: SonarSource/sonarqube-scan-action@v4
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}
        with:
          args: >
            -Dsonar.projectKey=${{ inputs.sonar-project-key }}
            -Dsonar.sources=${{ inputs.working-directory }}
            -Dsonar.exclusions=${{ inputs.sonar-exclude }}
            -Dsonar.tests=tests
            -Dsonar.python.coverage.reportPaths=${{ inputs.coverage-xml-path }}

  
  # # ============================
  # # Job 5 - Build/package
  # # ============================
  # build:
  #   runs-on: ${{ inputs.runner-build }}
  #   needs: [sonar, gitleaks ]
  #   defaults:
  #     run:
  #       working-directory: ${{ inputs.working-directory }}
  #   steps:
  #     - uses: actions/checkout@v4
  #       with:
  #         fetch-depth: 0

  #     - name: Set up Python
  #       uses: actions/setup-python@v5
  #       with:
  #         python-version: ${{ inputs.python-version }}

  #     - name: Install build dependencies
  #       run: |
  #         python -m pip install --upgrade pip
  #         if [ -f requirements.txt ]; then
  #           pip install -r requirements.txt
  #         fi

  #     - name: Build Python package
  #       run: |
  #         if [ -f pyproject.toml ]; then
  #           pip install build
  #           python -m build
  #         elif [ -f setup.py ]; then
  #           python setup.py sdist bdist_wheel
  #         else
  #           echo "No build configuration found, skipping build."
  #         fi

  # ============================
  # Job 4 - Cleanup SG Whitelist (always run if setup ran)
  # ============================
  cleanup-sg-whitelist:
    runs-on: ${{ inputs.runner-build }}
    if: ${{ always() && inputs.enable-aws-sg-whitelist == true && needs.setup-sg-whitelist.result == 'success' }}
    needs: [setup-sg-whitelist, sonar]

    steps:
      - name: Configure AWS Credentials   # ← important! need credentials again
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ inputs.aws-role-arn }}
          aws-region: ${{ inputs.aws-region }}

      - name: Remove Runner IP from Security Group
        shell: bash
        run: |
          IP="${{ needs.setup-sg-whitelist.outputs.runner-ip }}/32"
          echo "Removing IP: $IP"

          # Best-effort revoke (ignore if rule doesn't exist)
          aws ec2 revoke-security-group-ingress \
            --region ${{ inputs.aws-region }} \
            --group-id ${{ inputs.aws-security-group-id }} \
            --protocol tcp \
            --port 22 \
            --cidr "$IP" || true

          aws ec2 revoke-security-group-ingress \
            --region ${{ inputs.aws-region }} \
            --group-id ${{ inputs.aws-security-group-id }} \
            --protocol tcp \
            --port 3306 \
            --cidr "$IP" || true
