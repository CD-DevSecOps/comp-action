name: Build Python App (Reusable)

on:
  workflow_call:
    inputs:
      create-dotenv:
        description: 'Whether to create .env file from secrets'
        required: false
        type: boolean
        default: false

      enable-aws-sg-whitelist:
        description: 'Temporarily whitelist runner IP in AWS Security Group'
        required: false
        type: boolean
        default: false

      aws-role-arn:
        description: 'ARN of IAM role to assume for SG modification'
        required: false
        type: string

      aws-region:
        description: 'AWS region for Security Group'
        required: false
        type: string
        default: us-east-1

      aws-security-group-id:
        description: 'Security Group ID to modify'
        required: false
        type: string

      # Existing inputs
      runner-build:
        description: 'Runner for Python jobs'
        required: false
        type: string
        default: ubuntu-latest

      run-gitleaks:
        description: 'Run Gitleaks secret scanning'
        required: false
        type: boolean
        default: false

      python-version:
        description: 'Python version to use'
        required: true
        type: string

      sonar-project-key:
        description: 'SonarQube project key'
        required: true
        type: string

      sonar-exclude:
        description: 'SonarQube exclude patterns'
        required: false
        type: string
        default: '**/venv/**,**/.venv/**,**/dist/**,**/build/**,**/*.pyc,**/__pycache__/**'

      run-tests:
        description: 'Run pytest with coverage'
        required: false
        type: boolean
        default: true

      coverage-xml-path:
        description: 'Path to coverage XML report'
        required: false
        type: string
        default: coverage.xml

      working-directory:
        description: 'Directory where the Python app lives'
        required: false
        type: string
        default: '.'

      # .env inputs (if create-dotenv is true)
      DBNAME:
        required: false
        type: string
      DBUSERNAME:
        required: false
        type: string
      DBHOST:
        required: false
        type: string
      TENANTID:
        required: false
        type: string
      CLIENTID:
        required: false
        type: string

    secrets:
      SONAR_HOST_URL:
        required: true
      SONAR_TOKEN:
        required: true
      DBPASSWORD:
        required: false
      CLIENTSECRET:
        required: false
      OTHER_SECRET:
        required: false

permissions:
  contents: read
  id-token: write  # Required for OIDC AWS assume role
  pull-requests: read

jobs:
  # ============================
  # Job 1 - Gitleaks (optional)
  # ============================
  gitleaks:
    runs-on: ${{ inputs.runner-build }}
    if: ${{ inputs.run-gitleaks == true }}
    defaults:
      run:
        working-directory: ${{ inputs.working-directory }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install Gitleaks
        run: |
          curl -sSL https://github.com/gitleaks/gitleaks/releases/download/v8.18.4/gitleaks_8.18.4_linux_x64.tar.gz | tar xz
          sudo mv gitleaks /usr/local/bin/

      - name: Run Gitleaks (non-blocking)
        run: |
          set +e
          gitleaks detect --source . -v --redact
          echo "Gitleaks finished; leaks (if any) do not fail the build."
          set -e

  # ============================
  # Job 2 - Setup SG Whitelist (if enabled)
  # ============================
  setup-sg-whitelist:
    runs-on: ${{ inputs.runner-build }}
    if: ${{ inputs.enable-aws-sg-whitelist == true }}
    outputs:
      runner-ip: ${{ steps.ip.outputs.ipv }}
    steps:
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ inputs.aws-role-arn }}
          aws-region: ${{ inputs.aws-region }}

      - name: Get Runner Public IP
        id: ip
        uses: haythem/public-ip@v1.3

      - name: Add Runner IP to Security Group
        run: |
          IP="${{ steps.ip.outputs.ipv }}/32"
          aws ec2 authorize-security-group-ingress --group-id ${{ inputs.aws-security-group-id }} --protocol tcp --port 22 --cidr $IP || true
          aws ec2 authorize-security-group-ingress --group-id ${{ inputs.aws-security-group-id }} --protocol tcp --port 3306 --cidr $IP || true

  # ============================
  # Job 3 - Tests + Sonar
  # ============================
  sonar:
    runs-on: ${{ inputs.runner-build }}
    needs: [gitleaks, setup-sg-whitelist]
    if: ${{ always() && (needs.gitleaks.result == 'success' || needs.gitleaks.result == 'skipped') }}
    defaults:
      run:
        working-directory: ${{ inputs.working-directory }}

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set environment variables from secrets
        if: ${{ inputs.create-dotenv == true }}
        run: |
          echo "DBNAME=${{ inputs.DBNAME }}" >> $GITHUB_ENV
          echo "DBUSERNAME=${{ inputs.DBUSERNAME }}" >> $GITHUB_ENV
          echo "DBPASSWORD=${{ secrets.DBPASSWORD }}" >> $GITHUB_ENV
          echo "DBHOST=${{ inputs.DBHOST }}" >> $GITHUB_ENV
          echo "TENANTID=${{ inputs.TENANTID }}" >> $GITHUB_ENV
          echo "CLIENTID=${{ inputs.CLIENTID }}" >> $GITHUB_ENV
          echo "CLIENTSECRET=${{ secrets.CLIENTSECRET }}" >> $GITHUB_ENV
          # Add more lines here for additional variables as needed

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ inputs.python-version }}

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          fi

      - name: Run tests with coverage
        if: ${{ inputs.run-tests == true }}
        run: |
          pip install pytest pytest-cov
          pytest --cov=. --cov-report=xml:${{ inputs.coverage-xml-path }}
        env:
          PYTHONPATH: ${{ inputs.working-directory }}

      - name: SonarQube Scan
        uses: SonarSource/sonarqube-scan-action@v4
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}
        with:
          args: >
            -Dsonar.projectKey=${{ inputs.sonar-project-key }}
            -Dsonar.sources=${{ inputs.working-directory }}
            -Dsonar.exclusions=${{ inputs.sonar-exclude }}
            -Dsonar.tests=tests
            -Dsonar.python.coverage.reportPaths=${{ inputs.coverage-xml-path }}

  
  # ============================
  # Job 5 - Build/package
  # ============================
  build:
    runs-on: ${{ inputs.runner-build }}
    needs: [sonar, gitleaks ]
    defaults:
      run:
        working-directory: ${{ inputs.working-directory }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ inputs.python-version }}

      - name: Install build dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          fi

      - name: Build Python package
        run: |
          if [ -f pyproject.toml ]; then
            pip install build
            python -m build
          elif [ -f setup.py ]; then
            python setup.py sdist bdist_wheel
          else
            echo "No build configuration found, skipping build."
          fi

  # ============================
  # Job 4 - Cleanup SG Whitelist (always run if setup ran)
  # ============================
  # cleanup-sg-whitelist:
  #   runs-on: ${{ inputs.runner-build }}
  #   if: ${{ always() && inputs.enable-aws-sg-whitelist == true && needs.setup-sg-whitelist.result == 'success' }}
  #   needs: [setup-sg-whitelist, sonar]
  #   steps:
  #     - name: Configure AWS Credentials
  #       uses: aws-actions/configure-aws-credentials@v4
  #       with:
  #         role-to-assume: ${{ inputs.aws-role-arn }}
  #         aws-region: ${{ inputs.aws-region }}

  #     - name: Get Runner Public IP
  #       id: ip
  #       uses: haythem/public-ip@v1.3

  #     - name: Remove Runner IP from Security Group
  #       run: |
  #         IP="${{ steps.ip.outputs.ipv4 }}/32"
  #         aws ec2 revoke-security-group-ingress --group-id ${{ inputs.aws-security-group-id }} --protocol tcp --port 22 --cidr $IP || true
  #         aws ec2 revoke-security-group-ingress --group-id ${{ inputs.aws-security-group-id }} --protocol tcp --port 3306 --cidr $IP || true
